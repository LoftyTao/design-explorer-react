name: Build Windows Executable

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Configure Vite Base
        run: |
          $script = @'
          const fs = require('fs');
          const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
          pkg.homepage = '.';
          
          if (pkg.scripts && pkg.scripts.build) {
             if (!pkg.scripts.build.includes('--base')) {
                pkg.scripts.build += ' --base=./';
             }
          }
          fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));
          '@
          $script | Out-File -FilePath config-vite.cjs -Encoding utf8
          node config-vite.cjs

      - name: Build for production
        run: npm run build

      - name: Install Electron dependencies
        run: |
          npm install --save-dev electron electron-builder

      - name: Create Electron main process file
        run: |
          $content = @"
          const { app, BrowserWindow, protocol, net } = require('electron');
          const path = require('path');
          const { pathToFileURL } = require('url');

          protocol.registerSchemesAsPrivileged([
            { scheme: 'app', privileges: { secure: true, standard: true, supportFetchAPI: true, corsEnabled: true } }
          ]);

          function createWindow() {
            const win = new BrowserWindow({
              width: 1400,
              height: 900,
              webPreferences: {
                nodeIntegration: false,
                contextIsolation: true,
                webSecurity: false
              }
            });
            
            win.loadURL('app://design-explorer/index.html');
          }

          app.whenReady().then(() => {
            protocol.handle('app', (request) => {
              const url = new URL(request.url);
              let pathname = url.pathname;
              
              if (pathname.startsWith('/')) {
                pathname = pathname.slice(1);
              }
              
              const filePath = path.join(__dirname, 'dist', decodeURIComponent(pathname));
              return net.fetch(pathToFileURL(filePath).toString());
            });

            createWindow();
          });

          app.on('window-all-closed', () => {
            if (process.platform !== 'darwin') app.quit();
          });
          "@
          $content | Out-File -FilePath electron-main.cjs -Encoding utf8

      - name: Configure Package.json
        if: startsWith(github.ref, 'refs/tags/')
        env:
          TAG_NAME: ${{ github.ref_name }}
        run: |
          $script = @'
          const fs = require('fs');
          const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
          
          const version = process.env.TAG_NAME.replace(/^v/, '');
          pkg.version = version;
          pkg.main = 'electron-main.cjs';
          
          pkg.build = {
            appId: 'com.designexplorer.app',
            productName: 'Design Explorer',
            files: ['dist/**/*', 'electron-main.cjs', 'package.json'],
            artifactName: '${productName}-Setup-${version}.${ext}',
            win: {
              target: 'nsis',
              icon: 'public/icon.ico'
            },
            nsis: {
              oneClick: false,
              allowToChangeInstallationDirectory: true,
              createDesktopShortcut: true,
              perMachine: false,
              runAfterFinish: true
            }
          };
          
          fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));
          '@
          
          $script | Out-File -FilePath update-config.cjs -Encoding utf8
          node update-config.cjs

      - name: Build Windows executable
        run: npx electron-builder --win --x64
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: design-explorer-windows
          path: dist/*.exe
          retention-days: 30

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*.exe
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
